# Geth æºç ç³»åˆ—ï¼šå­˜å‚¨è®¾è®¡åŠå®ç°

Author: Po

è¿™ç¯‡æ–‡ç« æ˜¯ Geth æºç ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œé€šè¿‡è¿™ä¸ªç³»åˆ—ï¼Œæˆ‘ä»¬å°†æ­å»ºä¸€ä¸ªç ”ç©¶ Geth å®ç°çš„æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è¿™ä¸ªæ¡†æ¶æ·±å…¥è‡ªå·±æ„Ÿå…´è¶£çš„éƒ¨åˆ†ç ”ç©¶ã€‚è¿™ä¸ªç³»åˆ—å…±æœ‰å…­ç¯‡æ–‡ç« ï¼Œåœ¨è¿™ç¬¬äºŒç¯‡æ–‡ç« ä¸­ï¼Œå°†ç³»ç»Ÿè®²è§£ Geth çš„å­˜å‚¨ç»“æ„è®¾è®¡ä¸ç›¸å…³æºç ï¼Œä»‹ç»å…¶æ•°æ®åº“å±‚æ¬¡åˆ’åˆ†å¹¶è¯¦ç»†åˆ†æå„ä¸ªå±‚æ¬¡ä¸­ç›¸åº”æ¨¡å—çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

ä»¥å¤ªåŠä½œä¸ºå…¨çƒæœ€å¤§çš„åŒºå—é“¾å¹³å°ï¼Œå…¶ä¸»æµå®¢æˆ·ç«¯ Gethï¼ˆGo-Ethereumï¼‰æ‰¿æ‹…äº†ç»å¤§éƒ¨åˆ†èŠ‚ç‚¹è¿è¡Œä¸çŠ¶æ€ç®¡ç†çš„èŒè´£ã€‚Geth çš„çŠ¶æ€å­˜å‚¨ç³»ç»Ÿï¼Œæ˜¯ç†è§£ä»¥å¤ªåŠè¿è¡Œæœºåˆ¶ã€ä¼˜åŒ–èŠ‚ç‚¹æ€§èƒ½ã€ä»¥åŠæ¨åŠ¨æœªæ¥å®¢æˆ·ç«¯åˆ›æ–°çš„åŸºç¡€ã€‚

# 1. Gethåº•å±‚æ•°æ®åº“æ€»è§ˆ

è‡ª Geth v1.9.0 ç‰ˆæœ¬èµ·ï¼ŒGeth å°†å…¶æ•°æ®åº“åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š**å¿«é€Ÿè®¿é—®å­˜å‚¨**ï¼ˆKVæ•°æ®åº“ï¼Œç”¨äºæœ€è¿‘çš„åŒºå—å’ŒçŠ¶æ€æ•°æ®ï¼‰å’Œç§°ä¸º **freezer çš„å­˜å‚¨**ï¼ˆç”¨äºè¾ƒæ—§çš„åŒºå—å’Œæ”¶æ®æ•°æ®ï¼Œå³â€œancientsâ€ï¼‰ã€‚

è¿™æ ·åˆ’åˆ†çš„ç›®çš„æ˜¯å‡å°‘å¯¹æ˜‚è´µã€æ˜“æŸçš„ SSD çš„ä¾èµ–ï¼Œå°†è®¿é—®é¢‘ç‡è¾ƒä½çš„æ•°æ®è¿ç§»åˆ°æˆæœ¬æ›´ä½ã€è€ç”¨æ€§æ›´é«˜çš„ç£ç›˜ä¸Šã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿™ç§æ‹†åˆ†ä¹Ÿèƒ½å‡è½» LevelDB/PebbleDB çš„å‹åŠ›ï¼Œæé«˜å…¶æ•´ç†å’Œè¯»å–æ€§èƒ½ï¼Œä½¿å¾—åœ¨ç»™å®šçš„ç¼“å­˜å¤§å°ä¸‹ï¼Œæ›´å¤šçŠ¶æ€æ ‘èŠ‚ç‚¹èƒ½å¤Ÿå¸¸é©»å†…å­˜ï¼Œä»è€Œæå‡æ•´ä½“ç³»ç»Ÿæ•ˆç‡ã€‚

- **å¿«é€Ÿè®¿é—®å­˜å‚¨:** Geth ç”¨æˆ·å¯èƒ½å¯¹åº•å±‚æ•°æ®åº“çš„é€‰é¡¹è¾ƒä¸ºç†Ÿæ‚‰â€”â€”å¯ä»¥é€šè¿‡ `--db.engine` å‚æ•°è¿›è¡Œé…ç½®ã€‚ç›®å‰çš„é»˜è®¤é€‰é¡¹æ˜¯ `pebbledb`ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© `leveldb`ã€‚è¿™ä¸¤ä¸ªéƒ½æ˜¯ Geth æ‰€ä¾èµ–çš„ç¬¬ä¸‰æ–¹é”®å€¼æ•°æ®åº“ï¼Œè´Ÿè´£å­˜å‚¨è·¯å¾„ä¸º `datadir/geth/chaindata`ï¼ˆæ‰€æœ‰çš„åŒºå—å’ŒçŠ¶æ€æ•°æ®ï¼‰å’Œ `datadir/geth/nodes`ï¼ˆæ•°æ®åº“å…ƒæ•°æ®æ–‡ä»¶ï¼Œä½“ç§¯å¾ˆå°ï¼‰çš„æ–‡ä»¶ã€‚é€šè¿‡ `--history.state value` è®¾ç½®å¿«é€Ÿè®¿é—®ä¿å­˜çš„æœ€è¿‘å†å²çŠ¶æ€åŒºå—æ•°ï¼Œé»˜è®¤ä¸º90,000ä¸ªåŒºå—ã€‚
- **freezer** æˆ– **ancientså­˜å‚¨ï¼ˆå†å²æ•°æ®ï¼‰**ï¼Œå…¶ç›®å½•è·¯å¾„é€šå¸¸ä¸º `datadir/geth/chaindata/ancients`ã€‚ç”±äºå†å²æ•°æ®åŸºæœ¬æ˜¯é™æ€çš„ï¼Œä¸éœ€è¦é«˜æ€§èƒ½ I/Oï¼Œå› æ­¤å¯ä»¥èŠ‚çœå®è´µçš„ SSD ç©ºé—´ï¼Œç”¨äºå­˜å‚¨æ›´æ´»è·ƒçš„æ•°æ®ã€‚

æœ¬æ–‡çš„é‡ç‚¹æ˜¯çŠ¶æ€æ•°æ®ï¼Œå®ƒå­˜å‚¨åœ¨ ****KV æ•°æ®åº“ä¸­ã€‚å› æ­¤ï¼Œæ–‡ä¸­æåˆ°çš„åº•å±‚æ•°æ®åº“é»˜è®¤æ˜¯æŒ‡è¿™ä¸ª KV å­˜å‚¨ï¼Œè€Œé freezerã€‚

## Geth å­˜å‚¨ç»“æ„ï¼šäº”ä¸ªé€»è¾‘æ•°æ®åº“

Geth çš„åº•å±‚ä½¿ç”¨ LevelDB/PebbleDB å­˜å‚¨æ‰€æœ‰ä»¥ [RLP](https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/) ç¼–ç åçš„æ•°æ®ï¼Œä½†å…¶é€»è¾‘ä¸Šåˆ’åˆ†å‡ºäº”ç§ç”¨é€”ä¸åŒçš„æ•°æ®åº“ï¼š

| åç§° | æè¿° |
| --- | --- |
| State Trie | ä¸–ç•ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬è´¦æˆ·ã€åˆçº¦å­˜å‚¨ |
| Contract Codes | åˆçº¦ä»£ç  |
| State snapshot | ä¸–ç•ŒçŠ¶æ€å¿«ç…§ |
| Receipts | äº¤æ˜“æ”¶æ® |
| Headers/Blocks | åŒºå—æ•°æ® |

æ¯ç§æ•°æ®é€šè¿‡ key å‰ç¼€ï¼ˆ`core/rawdb/schema.go`ï¼‰åŒºåˆ†ï¼Œé€»è¾‘ä¸Šå®ç°èŒè´£åˆ†ç¦»ã€‚é€šè¿‡`geth db inspect`å¯ä»¥æŸ¥çœ‹ Geth å­˜å‚¨çš„æ‰€æœ‰ä»¥å¤ªåŠæ•°æ®ï¼ˆå—é«˜22,347,000ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ç£ç›˜ç©ºé—´å ç”¨æœ€å¤§çš„æ˜¯åŒºå—ã€æ”¶æ®å’ŒçŠ¶æ€æ•°æ®ã€‚

```bash
+-----------------------+-----------------------------+------------+------------+
|       DATABASE        |          CATEGORY           |    SIZE    |   ITEMS    |
+-----------------------+-----------------------------+------------+------------+
| Key-Value store       | Headers                     | 576.00 B   |          1 |
| Key-Value store       | Bodies                      | 44.00 B    |          1 |
| Key-Value store       | Receipt lists               | 42.00 B    |          1 |
| Key-Value store       | Difficulties (deprecated)   | 0.00 B     |          0 |
| Key-Value store       | Block number->hash          | 42.00 B    |          1 |
| Key-Value store       | Block hash->number          | 873.78 MiB |   22347001 |
| Key-Value store       | Transaction index           | 13.48 GiB  |  391277094 |
| Key-Value store       | Log index filter-map rows   | 12.98 GiB  |  132798523 |
| Key-Value store       | Log index last-block-of-map | 2.73 MiB   |      59529 |
| Key-Value store       | Log index block-lv          | 45.05 MiB  |    2362175 |
| Key-Value store       | Log bloombits (deprecated)  | 0.00 B     |          0 |
| Key-Value store       | Contract codes              | 9.81 GiB   |    1587159 |
| Key-Value store       | Hash trie nodes             | 0.00 B     |          0 |
| Key-Value store       | Path trie state lookups     | 19.62 KiB  |        490 |
| Key-Value store       | Path trie account nodes     | **45.88 GiB**  |  397626541 |
| Key-Value store       | Path trie storage nodes     | **176.23 GiB** | 1753966511 |
| Key-Value store       | Verkle trie nodes           | 0.00 B     |          0 |
| Key-Value store       | Verkle trie state lookups   | 0.00 B     |          0 |
| Key-Value store       | Trie preimages              | 0.00 B     |          0 |
| Key-Value store       | Account snapshot            | 13.34 GiB  |  290797237 |
| Key-Value store       | Storage snapshot            | **93.42 GiB**  | 1295163402 |
| Key-Value store       | Beacon sync headers         | 622.00 B   |          1 |
| Key-Value store       | Clique snapshots            | 0.00 B     |          0 |
| Key-Value store       | Singleton metadata          | 1.36 MiB   |         20 |
| Ancient store (Chain) | Hashes                      | 809.85 MiB |   22347001 |
| Ancient store (Chain) | Bodies                      | **639.98 GiB** |   22347001 |
| Ancient store (Chain) | Receipts                    | **244.19 GiB** |   22347001 |
| Ancient store (Chain) | Headers                     | 10.69 GiB  |   22347001 |
| Ancient store (State) | History.Meta                | 37.58 KiB  |        487 |
| Ancient store (State) | Account.Index               | 5.80 MiB   |        487 |
| Ancient store (State) | Storage.Index               | 7.47 MiB   |        487 |
| Ancient store (State) | Account.Data                | 6.46 MiB   |        487 |
| Ancient store (State) | Storage.Data                | 2.70 MiB   |        487 |
+-----------------------+-----------------------------+------------+------------+
|                                    TOTAL            |  1.23 TIB  |            |
+-----------------------+-----------------------------+------------+------------+
```

# 2. æºç è§†è§’ä¸‹çš„å­˜å‚¨åˆ†å±‚: 6ç§DB

æ€»ä½“è€Œè¨€ï¼ŒGeth ä¸­åŒ…å« `StateDB`ã€`state.Database`ã€`trie.Trie`ã€`TrieDB`ã€`rawdb` å’Œ `ethdb` å…­ä¸ªæ•°æ®åº“æ¨¡å—ï¼Œå®ƒä»¬å¦‚åŒä¸€æ£µâ€œçŠ¶æ€ç”Ÿå‘½æ ‘â€çš„å„ä¸ªå±‚çº§ã€‚æœ€é¡¶å±‚çš„ `StateDB` æ˜¯ EVM æ‰§è¡Œé˜¶æ®µçš„çŠ¶æ€æ¥å£ï¼Œè´Ÿè´£å¤„ç†è´¦æˆ·ä¸å­˜å‚¨çš„è¯»å†™è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚é€å±‚ä¸‹ä¼ ï¼Œæœ€ç»ˆç”±æœ€åº•å±‚è´Ÿè´£ç‰©ç†æŒä¹…åŒ–çš„ `ethdb` è¯»/å†™ç‰©ç†æ•°æ®åº“ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¾æ¬¡ä»‹ç»è¿™å…­ä¸ªæ•°æ®åº“æ¨¡å—çš„èŒè´£åŠå®ƒä»¬ä¹‹é—´çš„åä½œå…³ç³»ã€‚

![å­˜å‚¨æ¶æ„å›¾](Gethæºç ç³»åˆ—ï¼šå­˜å‚¨è®¾è®¡åŠå®ç°/image.png)

## 2.1 StateDB

åœ¨ Geth ä¸­ï¼Œ`StateDB` æ˜¯ **EVM ä¸åº•å±‚çŠ¶æ€å­˜å‚¨ä¹‹é—´çš„å”¯ä¸€æ¡¥æ¢**ï¼Œè´Ÿè´£æŠ½è±¡å’Œç®¡ç†åˆçº¦è´¦æˆ·ã€ä½™é¢ã€nonceã€å­˜å‚¨æ§½ç­‰ä¿¡æ¯çš„è¯»å†™ï¼Œå¯¹æ‰€æœ‰å…¶ä»–æ•°æ®åº“ï¼ˆTrieDB, EthDBï¼‰çš„çŠ¶æ€ç›¸å…³è¯»å†™éƒ½ç”± `StateDB` ä¸­çš„ç›¸å…³æ¥å£è§¦å‘ï¼Œå¯ä»¥è¯´ **StateDB æ˜¯æ‰€æœ‰çŠ¶æ€æ•°æ®åº“çš„å¤§è„‘**ã€‚å®ƒå¹¶ä¸ç›´æ¥æ“ä½œåº•å±‚çš„ Trie æˆ–åº•å±‚æ•°æ®åº“ï¼ˆethdbï¼‰ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªç®€åŒ–çš„å†…å­˜è§†å›¾ï¼Œè®© EVM èƒ½ä»¥ç†Ÿæ‚‰çš„è´¦æˆ·æ¨¡å‹è¿›è¡Œäº¤äº’ã€‚å› æ­¤ï¼Œå¤šæ•°ä¾èµ– Geth çš„é¡¹ç›®å…¶å®ä¹Ÿä¸ä¼šå…³å¿ƒåº•å±‚çš„ `EthDB`æˆ– `TrieDB` æ˜¯æ€ä¹ˆå®ç°çš„â€”â€”å®ƒä»¬èƒ½æ­£å¸¸å·¥ä½œå°±å¤Ÿäº†ï¼Œæ²¡å¿…è¦åŠ¨ã€‚å¤§å¤šæ•°åŸºäº Geth çš„åˆ†å‰é¡¹ç›®éƒ½ä¼šä¿®æ”¹ `StateDB` ç»“æ„ï¼Œä»¥é€‚åº”è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚ä¾‹å¦‚ï¼ŒArbitrum ä¿®æ”¹äº† `StateDB` ä»¥ç®¡ç†å®ƒä»¬çš„ Stylus ç¨‹åºï¼›EVMOS ä¿®æ”¹äº† `StateDB` æ¥è¿½è¸ªå¯¹å…¶æœ‰çŠ¶æ€é¢„ç¼–è¯‘åˆçº¦ï¼ˆstateful precompileï¼‰çš„è°ƒç”¨ã€‚

æºç ä¸­ï¼Œ`StateDB` çš„ä¸»è¦å®šä¹‰ä½äº `core/state/statedb.go`ã€‚å®ƒçš„æ ¸å¿ƒç»“æ„ç»´æŠ¤äº†ä¸€ç³»åˆ—å†…å­˜çŠ¶æ€å¯¹è±¡ï¼ˆ`stateObject`ï¼‰ï¼Œæ¯ä¸ª`stateObject`å¯¹åº”ä¸€ä¸ªè´¦æˆ·ï¼ˆåŒ…å«åˆçº¦å­˜å‚¨ï¼‰ã€‚å®ƒè¿˜åŒ…å«ä¸€ä¸ª `journal`ï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰ç”¨äºæ”¯æŒå›æ»šï¼Œä»¥åŠç”¨äºè¿½è¸ªçŠ¶æ€æ›´æ”¹çš„ç¼“å­˜æœºåˆ¶ã€‚åœ¨äº¤æ˜“å¤„ç†å’ŒåŒºå—æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œ`StateDB` æä¾›ä¸´æ—¶çŠ¶æ€å˜æ›´çš„è®°å½•ï¼Œåªæœ‰åœ¨æœ€ç»ˆç¡®è®¤åæ‰ä¼šå†™å…¥åº•å±‚æ•°æ®åº“ã€‚

`StateDB` çš„æ ¸å¿ƒè¯»å†™æ¥å£å¦‚ä¸‹ï¼ŒåŸºæœ¬éƒ½æ˜¯è´¦æˆ·æ¨¡å‹ç›¸å…³çš„API:

```go
// è¯»ç›¸å…³
func (s *StateDB) GetBalance(addr common.Address) *uint256.Int 
func (s *StateDB) GetStorageRoot(addr common.Address) common.Hash 
// å†™å…¥dirtyçŠ¶æ€æ•°æ®
func (s *StateDB) SetStorage(addr common.Address, storage map[common.Hash]common.Hash) 
// å°†EVMæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„çŠ¶æ€å˜æ›´(dirtyæ•°æ®) commitåˆ°åç«¯æ•°æ®åº“ä¸­
func (s *StateDB) commitAndFlush(block uint64, deleteEmptyObjects bool, noStorageWiping bool) (*stateUpdate, error) 
```

### **ç”Ÿå‘½å‘¨æœŸ**

`StateDB`çš„ç”Ÿå‘½å‘¨æœŸåªæŒç»­ä¸€ä¸ªåŒºå—ã€‚åœ¨ä¸€ä¸ªåŒºå—è¢«å¤„ç†å¹¶æäº¤ä¹‹åï¼Œè¿™ä¸ª `StateDB` å°±ä¼šè¢«åºŸå¼ƒï¼Œä¸å†å…·æœ‰ä½œç”¨

- EVM ç¬¬ä¸€æ¬¡è¯»å–æŸä¸ªåœ°å€æ—¶ï¼Œ`StateDB` ä¼šä»`Trieâ†’TrieDBâ†’EthDB`æ•°æ®åº“ä¸­åŠ è½½å®ƒçš„å€¼ï¼Œå¹¶å°†å…¶ç¼“å­˜ä¸€ä¸ªæ–°çš„çŠ¶æ€å¯¹è±¡ï¼ˆ`stateObject.originalStorage`ï¼‰ä¸­ã€‚è¿™ä¸€é˜¶æ®µè¢«è§†ä¸ºâ€œå¹²å‡€çš„å¯¹è±¡â€ï¼ˆclean objectï¼‰ã€‚
- å½“äº¤æ˜“ä¸è¯¥è´¦æˆ·å‘ç”Ÿäº¤äº’å¹¶æ”¹å˜å…¶çŠ¶æ€æ—¶ï¼Œå¯¹è±¡å°±å˜æˆâ€œè„çš„â€ï¼ˆdirtyï¼‰ã€‚`stateObject`ä¼šåŒæ—¶è¿½è¸ªè¯¥è´¦æˆ·çš„åŸå§‹çŠ¶æ€å’Œæ‰€æœ‰ä¿®æ”¹åçš„æ•°æ®ï¼ŒåŒ…æ‹¬å…¶å­˜å‚¨æ§½åŠå…¶å¹²å‡€/è„çŠ¶æ€ã€‚
- å¦‚æœæ•´ä¸ªäº¤æ˜“æœ€ç»ˆæˆåŠŸè¢«æ‰“åŒ…åˆ°åŒºå—ï¼Œ`StateDB.Finalise()` ä¼šè¢«è°ƒç”¨ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£æ¸…ç†å·² `selfdestruct` çš„åˆçº¦ï¼Œå¹¶é‡ç½® journalï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰ä»¥åŠ gas refund è®¡æ•°å™¨ã€‚
- å½“æ‰€æœ‰äº¤æ˜“éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œ`StateDB.Commit()` è¢«è°ƒç”¨ã€‚åœ¨è¿™ä¹‹å‰ï¼ŒçŠ¶æ€æ ‘`Trie`å®é™…ä¸Šè¿˜æœªè¢«æ›´æ”¹ã€‚ç›´åˆ°è¿™ä¸€æ­¥ï¼Œ`StateDB` æ‰ä¼šå°†å†…å­˜ä¸­çš„çŠ¶æ€å˜æ›´å†™å…¥å­˜å‚¨ `Trie`ï¼Œè®¡ç®—å‡ºæ¯ä¸ªè´¦æˆ·çš„æœ€ç»ˆ storage rootï¼Œä»è€Œç”Ÿæˆè´¦æˆ·çš„æœ€ç»ˆçŠ¶æ€ã€‚æ¥ä¸‹æ¥ï¼Œæ‰€æœ‰â€œè„â€çš„çŠ¶æ€å¯¹è±¡ä¼šè¢«å†™å…¥ `Trie`ä¸­ï¼Œæ›´æ–°å…¶ç»“æ„å¹¶è®¡ç®—æ–°çš„ `stateRoot`ã€‚
- æœ€åï¼Œè¿™äº›æ›´æ–°åçš„èŠ‚ç‚¹ä¼šè¢«ä¼ é€’ç»™ `TrieDB`ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒçš„åç«¯ï¼ˆPathDB/HashDBï¼‰ç¼“å­˜è¿™äº›èŠ‚ç‚¹ï¼Œå¹¶æœ€ç»ˆå°†å®ƒä»¬æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆLevelDB/PebbleDBï¼‰â€”â€”å‰ææ˜¯è¿™äº›æ•°æ®æ²¡æœ‰å› ä¸ºé“¾é‡ç»„è¢«ä¸¢å¼ƒã€‚

## 2.2 State.Database

`state.Database` æ˜¯ Geth ä¸­è¿æ¥ `StateDB` ä¸åº•å±‚æ•°æ®åº“ï¼ˆ`EthDB` ä¸ `TrieDB`ï¼‰çš„é‡è¦ä¸­é—´å±‚ï¼Œå®ƒä¸ºçŠ¶æ€è®¿é—®æä¾›äº†ä¸€ç»„ç®€æ´çš„æ¥å£å’Œå®ç”¨æ–¹æ³•ã€‚è™½ç„¶å®ƒçš„æ¥å£æ¯”è¾ƒè–„ï¼Œä½†åœ¨æºç ä¸­ï¼Œå®ƒæ‰®æ¼”äº†å¤šä¸ªå…³é”®è§’è‰²ï¼Œå°¤å…¶æ˜¯åœ¨çŠ¶æ€æ ‘è®¿é—®ä¸ä¼˜åŒ–æ–¹é¢ã€‚

åœ¨ Geth æºç ä¸­ï¼ˆ`core/state/database.go`ï¼‰ï¼Œ`state.Database` æ¥å£ç”± `state.cachingDB` è¿™ä¸€å…·ä½“æ•°æ®ç»“æ„å®ç°ã€‚å®ƒçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š

---

- **æä¾›ç»Ÿä¸€çš„çŠ¶æ€è®¿é—®æ¥å£**

`state.Database` æ˜¯æ„å»º `StateDB` çš„å¿…è¦ä¾èµ–ï¼Œå®ƒå°è£…äº†æ‰“å¼€è´¦æˆ· Trie å’Œå­˜å‚¨ Trie çš„é€»è¾‘ï¼Œä¾‹å¦‚ï¼š

```go
func (db *cachingDB) OpenTrie(root common.Hash) (Trie, error)
func (db *cachingDB) OpenStorageTrie(stateRoot common.Hash, address common.Address, root common.Hash, trie Trie) (Trie, error)
```

è¿™äº›æ–¹æ³•éšè—äº†åº•å±‚ `TrieDB` çš„å¤æ‚æ€§ï¼Œå¼€å‘è€…åœ¨æ„å»ºæŸä¸ªåŒºå—çš„çŠ¶æ€æ—¶ï¼Œåªéœ€è°ƒç”¨è¿™äº›æ–¹æ³•è·å–æ­£ç¡®çš„ Trie å®ä¾‹ï¼Œè€Œä¸å¿…ç›´æ¥æ“ä½œ hash è·¯å¾„ã€trie ç¼–ç æˆ–åº•å±‚æ•°æ®åº“ã€‚

- **æš‚å­˜å’Œå¤ç”¨åˆçº¦ä»£ç ï¼ˆcode cacheï¼‰**

åˆçº¦ä»£ç çš„è®¿é—®ä»£ä»·è¾ƒé«˜ï¼Œä¸”å¾€å¾€åœ¨å¤šä¸ªå—ä¸­é‡å¤ä½¿ç”¨ã€‚ä¸ºæ­¤ï¼Œ`state.Database` ä¸­å®ç°äº†ä»£ç ç¼“å­˜é€»è¾‘ï¼Œé¿å…é‡å¤ä»ç£ç›˜åŠ è½½åˆçº¦å­—èŠ‚ç ã€‚è¿™ä¸€ä¼˜åŒ–å¯¹æé«˜åŒºå—æ‰§è¡Œæ•ˆç‡è‡³å…³é‡è¦ï¼š

```go
func (db *CachingDB) ContractCodeWithPrefix(address common.Address, codeHash common.Hash) []byte 
```

è¿™ä¸ªæ¥å£å…è®¸æŒ‰åœ°å€å’Œä»£ç å“ˆå¸Œå¿«é€Ÿå‘½ä¸­ç¼“å­˜ï¼Œè‹¥æœªå‘½ä¸­æ‰å›é€€åˆ°åº•å±‚æ•°æ®åº“åŠ è½½ã€‚

- **é•¿ç”Ÿå‘½å‘¨æœŸï¼Œè·¨å¤šä¸ªåŒºå—å¤ç”¨**

ä¸ `StateDB` çš„ç”Ÿå‘½å‘¨æœŸä»…é™äºå•ä¸ªåŒºå—ä¸åŒï¼Œ`state.Database` çš„ç”Ÿå‘½å‘¨æœŸå’Œæ•´ä¸ªé“¾ï¼ˆ`core.Blockchain`ï¼‰ä¿æŒä¸€è‡´ã€‚å®ƒåœ¨èŠ‚ç‚¹å¯åŠ¨æ—¶æ„é€ ï¼Œå¹¶è´¯ç©¿æ•´ä¸ªè¿è¡Œå‘¨æœŸï¼Œä½œä¸º `StateDB` çš„â€œå¿ å®ä¼™ä¼´â€ï¼Œä¸ºå…¶åœ¨æ¯ä¸ªåŒºå—å¤„ç†æ—¶æä¾›æ”¯æŒã€‚

---

- **ä¸ºæœªæ¥çš„ Verkle Tree è¿ç§»åšå‡†å¤‡**

è™½ç„¶å½“å‰ `state.Database` çœ‹ä¼¼åªæ˜¯â€œä»£ç ç¼“å­˜+trieè®¿é—®å°è£…â€ï¼Œä½†å®ƒåœ¨ Geth æ¶æ„ä¸­çš„å®šä½éå¸¸å‰ç»æ€§ã€‚ä¸€æ—¦æœªæ¥çš„çŠ¶æ€ç»“æ„åˆ‡æ¢è‡³ Verkle Trieï¼Œå®ƒå°†æˆä¸ºè¿ç§»è¿‡ç¨‹çš„æ ¸å¿ƒç»„ä»¶ï¼šå¤„ç†æ–°æ—§ç»“æ„ä¹‹é—´çš„æ¡¥æ¥çŠ¶æ€ã€‚

## 2.3 Trie

åœ¨ Geth ä¸­ï¼ŒçŠ¶æ€æ ‘`Trie`ï¼ˆ[Merkle Patricia Trie](https://ethereum.org/zh/developers/docs/data-structures-and-encoding/patricia-merkle-trie/)ï¼‰æœ¬èº«å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œä½† Trie æ‰¿æ‹…è®¡ç®—çŠ¶æ€æ ¹å“ˆå¸Œå’Œæ”¶é›†ä¿®æ”¹èŠ‚ç‚¹çš„æ ¸å¿ƒèŒè´£ï¼Œå¹¶èµ·åˆ°è¡”æ¥ `StateDB`ä¸åº•å±‚å­˜å‚¨ä¹‹é—´çš„æ¡¥æ¢ä½œç”¨ï¼Œæ˜¯ä»¥å¤ªåŠçŠ¶æ€ç³»ç»Ÿçš„ä¸­æ¢ç»“æ„ã€‚

å½“ EVM æ‰§è¡Œäº¤æ˜“æˆ–è°ƒç”¨åˆçº¦æ—¶ï¼Œå¹¶ä¸ä¼šç›´æ¥æ“ä½œåº•å±‚çš„æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡ `StateDB` é—´æ¥ä¸ `Trie`äº¤äº’ã€‚`Trie`æ¥æ”¶è´¦æˆ·åœ°å€å’Œå­˜å‚¨æ§½ä½çš„æŸ¥è¯¢ä¸æ›´æ–°è¯·æ±‚ï¼Œå¹¶åœ¨å†…å­˜ä¸­æ„å»ºçŠ¶æ€å˜åŒ–è·¯å¾„ã€‚è¿™äº›è·¯å¾„æœ€ç»ˆé€šè¿‡é€’å½’å“ˆå¸Œè¿ç®—ï¼Œè‡ªåº•å‘ä¸Šç”Ÿæˆæ–°çš„æ ¹å“ˆå¸Œï¼ˆstate rootï¼‰ï¼Œè¿™ä¸ªæ ¹å“ˆå¸Œæ˜¯å½“å‰ä¸–ç•ŒçŠ¶æ€çš„å”¯ä¸€æ ‡è¯†ï¼Œå¹¶è¢«å†™å…¥åŒºå—å¤´ä¸­ï¼Œç¡®ä¿çŠ¶æ€çš„å®Œæ•´æ€§å’Œå¯éªŒè¯æ€§ã€‚

åœ¨ä¸€ä¸ªåŒºå—æ‰§è¡Œå®Œæ¯•å¹¶è¿›å…¥æäº¤é˜¶æ®µï¼ˆ`StateDB.Commit`ï¼‰ï¼Œ`Trie`ä¼šå°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„èŠ‚ç‚¹â€œå¡Œç¼©â€ä¸ºä¸€ä¸ªå¿…è¦çš„å­é›†ï¼Œå¹¶ä¼ é€’ç»™ `TrieDB`ï¼Œç”±å…¶è¿›ä¸€æ­¥äº¤ç”±åç«¯çš„èŠ‚ç‚¹æ•°æ®åº“ï¼ˆå¦‚ HashDB æˆ– PathDBï¼‰æŒä¹…åŒ–ã€‚ç”±äº `Trie`èŠ‚ç‚¹ä»¥ç»“æ„åŒ–å½¢å¼ç¼–ç ï¼Œå®ƒæ—¢æ”¯æŒé«˜æ•ˆè¯»å–ï¼Œä¹Ÿä½¿å¾—çŠ¶æ€åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´å¯ä»¥å®‰å…¨åœ°åŒæ­¥å’ŒéªŒè¯ã€‚å› æ­¤ï¼ŒTrie ä¸åªæ˜¯ä¸€ä¸ªçŠ¶æ€å®¹å™¨ï¼Œæ›´æ˜¯è¿æ¥ä¸Šå±‚ EVM ä¸åº•å±‚å­˜å‚¨å¼•æ“çš„çº½å¸¦ï¼Œä½¿å¾—ä»¥å¤ªåŠçŠ¶æ€å…·å¤‡ä¸€è‡´æ€§ã€å®‰å…¨æ€§å’Œæ¨¡å—åŒ–å¯æ‰©å±•æ€§ã€‚

æºç ä¸­ï¼ŒTrieä¸»è¦å®šä½äº `trie/trie.go`ä¸­, å®ƒæä¾›äº†å¦‚ä¸‹æ ¸å¿ƒæ¥å£:

```go
type Trie interface {
	GetKey([]byte) []byte
	GetAccount(address common.Address) (*types.StateAccount, error)
	GetStorage(addr common.Address, key []byte) ([]byte, error)
	UpdateAccount(address common.Address, account *types.StateAccount, codeLen int) error
	UpdateStorage(addr common.Address, key, value []byte) error
	DeleteAccount(address common.Address) error
	DeleteStorage(addr common.Address, key []byte) error
	UpdateContractCode(address common.Address, codeHash common.Hash, code []byte) error
	Hash() common.Hash
	Commit(collectLeaf bool) (common.Hash, *trienode.NodeSet)
	Witness() map[string]struct{}
	NodeIterator(startKey []byte) (trie.NodeIterator, error)
	Prove(key []byte, proofDb ethdb.KeyValueWriter) error
	IsVerkle() bool
}
```

ä»¥èŠ‚ç‚¹æŸ¥è¯¢`trie.get`ä¸ºä¾‹ï¼Œå®ƒä¼šæ ¹æ®èŠ‚ç‚¹ç±»å‹é€’å½’åœ°æŸ¥æ‰¾è´¦æˆ·æˆ–åˆçº¦å­˜å‚¨å¯¹åº”çš„èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ˜¯log(n)ï¼Œnä¸ºè·¯å¾„æ·±åº¦ã€‚

```go
func (t *Trie) get(origNode node, key []byte, pos int) (value []byte, newnode node, didResolve bool, err error) {
	switch n := (origNode).(type) {
	case nil:
		return nil, nil, false, nil
	case valueNode:
		return n, n, false, nil
	case *shortNode:
		if !bytes.HasPrefix(key[pos:], n.Key) {
			// key not found in trie
			return nil, n, false, nil
		}
		value, newnode, didResolve, err = t.get(n.Val, key, pos+len(n.Key))
		if err == nil && didResolve {
			n.Val = newnode
		}
		return value, n, didResolve, err
	case *fullNode:
		value, newnode, didResolve, err = t.get(n.Children[key[pos]], key, pos+1)
		if err == nil && didResolve {
			n.Children[key[pos]] = newnode
		}
		return value, n, didResolve, err
	case hashNode:
		child, err := t.resolveAndTrack(n, key[:pos])
		if err != nil {
			return nil, n, true, err
		}
		value, newnode, _, err := t.get(child, key, pos)
		return value, newnode, true, err
	default:
		panic(fmt.Sprintf("%T: invalid node: %v", origNode, origNode))
	}
}
```

## 2.4 TrieDB

`TrieDB` æ˜¯`Trie`ä¸ç£ç›˜å­˜å‚¨ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œ**ä¸“æ³¨äº Trie èŠ‚ç‚¹çš„å­˜å–ä¸æŒä¹…åŒ–**ã€‚æ¯ä¸€ä¸ª Trie èŠ‚ç‚¹ï¼ˆæ— è®ºæ˜¯è´¦æˆ·ä¿¡æ¯è¿˜æ˜¯åˆçº¦çš„å­˜å‚¨æ§½ï¼‰æœ€ç»ˆéƒ½ä¼šé€šè¿‡ `TrieDB`è¿›è¡Œè¯»å†™ã€‚

ç¨‹åºå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ª `TrieDB` å®ä¾‹ï¼Œåœ¨èŠ‚ç‚¹å…³é—­æ—¶ä¼šè¢«é”€æ¯ã€‚å®ƒåœ¨åˆå§‹åŒ–æ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ª `EthDB` å®ä¾‹ï¼Œ`EthDB`å®ä¾‹è´Ÿè´£å…·ä½“çš„æ•°æ®æŒä¹…åŒ–æ“ä½œã€‚

ç›®å‰ï¼ŒGeth æ”¯æŒä¸¤ç§ TrieDB åç«¯å®ç°ï¼š

- **HashDB**ï¼šä¼ ç»Ÿæ–¹å¼ï¼Œä»¥å“ˆå¸Œä¸ºé”®ã€‚
- **PathDB**ï¼šæ–°å¼•å…¥çš„ Path-based æ¨¡å‹ï¼ˆGeth 1.14.0ç‰ˆæœ¬åé»˜è®¤é…ç½®ï¼‰ï¼Œä»¥è·¯å¾„ä¿¡æ¯ä½œä¸ºé”®ï¼Œä¼˜åŒ–äº†æ›´æ–°ä¸ä¿®å‰ªæ€§èƒ½ã€‚

æºç ä¸­ï¼ŒTrieDB ä¸»è¦ä½äº`triedb/database.go`ã€‚

### Trie èŠ‚ç‚¹çš„è¯»å–é€»è¾‘

æˆ‘ä»¬å…ˆæ¥çœ‹èŠ‚ç‚¹çš„è¯»å–æµç¨‹ï¼Œå› ä¸ºå®ƒç›¸å¯¹ç®€å•ã€‚

æ‰€æœ‰çš„ `TrieDB` åç«¯éƒ½å¿…é¡»å®ç°ä¸€ä¸ª `database.Reader` æ¥å£ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```go
type Reader interface {
    Node(owner common.Hash, path []byte, hash common.Hash) ([]byte, error)
}
```

è¿™ä¸ªæ¥å£æä¾›äº†åŸºæœ¬çš„èŠ‚ç‚¹æŸ¥è¯¢åŠŸèƒ½ï¼Œå®ƒä¼šæ ¹æ®è·¯å¾„ï¼ˆ`path`ï¼‰å’ŒèŠ‚ç‚¹å“ˆå¸Œï¼ˆ`hash`ï¼‰ä» trie æ ‘ä¸­å®šä½å¹¶è¿”å›è¯¥èŠ‚ç‚¹ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯åŸå§‹å­—èŠ‚æ•°ç»„ â€”â€” `TrieDB` å¯¹èŠ‚ç‚¹çš„å†…å®¹å¹¶ä¸å…³å¿ƒï¼Œä¹Ÿä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯è´¦æˆ·èŠ‚ç‚¹ã€å¶å­èŠ‚ç‚¹è¿˜æ˜¯åˆ†æ”¯èŠ‚ç‚¹ï¼ˆè¿™ç”±ä¸Šå±‚çš„`Trie`æ¥è§£æï¼‰ã€‚

æ¥å£ä¸­çš„ `owner` å‚æ•°ç”¨äºåŒºåˆ†ä¸åŒçš„ trieï¼š

- å¦‚æœæ˜¯è´¦æˆ· trieï¼Œåˆ™ `owner` ç•™ç©ºã€‚
- å¦‚æœæ˜¯åˆçº¦çš„å­˜å‚¨ trieï¼Œåˆ™ `owner` æ˜¯è¯¥åˆçº¦çš„åœ°å€ï¼Œå› ä¸ºæ¯ä¸ªåˆçº¦éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å­˜å‚¨ trieã€‚

æ¢å¥è¯è¯´ï¼Œ`TrieDB` æ˜¯åº•å±‚èŠ‚ç‚¹çš„**è¯»å†™æ€»çº¿**ï¼Œä¸ºä¸Šå±‚çš„ Trieæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä¸æ¶‰åŠè¯­ä¹‰ï¼Œåªå…³å¿ƒè·¯å¾„å’Œå“ˆå¸Œã€‚å®ƒè®© Trie ä¸ç‰©ç†å­˜å‚¨ç³»ç»Ÿä¹‹é—´è§£è€¦ï¼Œä½¿å¾—ä¸åŒå­˜å‚¨æ¨¡å‹å¯ä»¥çµæ´»æ›¿æ¢è€Œä¸å½±å“ä¸Šå±‚é€»è¾‘ã€‚

### TrieDB ä¹‹ HashDB

`TrieDB`å†å²ä¸Šé‡‡ç”¨çš„èŠ‚ç‚¹æŒä¹…åŒ–æ–¹å¼æ˜¯ï¼š

**å°†æ¯ä¸ª Trie èŠ‚ç‚¹çš„å“ˆå¸Œï¼ˆKeccak256ï¼‰ä½œä¸ºé”®ï¼Œå°†è¯¥èŠ‚ç‚¹çš„ RLP ç¼–ç ä½œä¸ºå€¼**ï¼Œå¹¶å†™å…¥åº•å±‚çš„ key-value å­˜å‚¨ä¸­ã€‚è¿™ç§æ–¹å¼ç°åœ¨è¢«ç§°ä¸º`HashDB`ã€‚

è¿™ç§è®¾è®¡æ–¹å¼éå¸¸ç›´æ¥ï¼Œä½†æœ‰å‡ ä¸ªæ˜¾è‘—çš„ä¼˜ç‚¹ï¼š

- **æ”¯æŒå¤šæ£µ Trie å¹¶å­˜**ï¼šåªéœ€çŸ¥é“æ ¹å“ˆå¸Œï¼Œå°±èƒ½éå†æ¢å¤æ•´ä¸ª Trieã€‚æ¯ä¸ªè´¦æˆ·çš„å­˜å‚¨ã€è´¦æˆ· Trieã€ä¸åŒå†å²çŠ¶æ€çš„æ ¹å“ˆå¸Œéƒ½å¯ä»¥åˆ†åˆ«ç®¡ç†ã€‚
- **å­æ ‘å»é‡ï¼ˆSubtrie Deduplicationï¼‰**ï¼šç”±äºç›¸åŒçš„å­æ ‘å…·æœ‰ç›¸åŒçš„ç»“æ„å’ŒèŠ‚ç‚¹å“ˆå¸Œï¼Œå®ƒä»¬åœ¨ `HashDB` ä¸­ä¼šè‡ªç„¶å…±äº«ï¼Œä¸éœ€è¦é‡å¤å­˜å‚¨ã€‚è¿™å¯¹äºä»¥å¤ªåŠçš„å¤§çŠ¶æ€æ ‘å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çŠ¶æ€åœ¨åŒºå—ä¹‹é—´æ˜¯ä¿æŒä¸å˜çš„ã€‚

è¦æ³¨æ„çš„æ˜¯ï¼Œ**æ™®é€šçš„ Geth èŠ‚ç‚¹å¹¶ä¸ä¼šåœ¨æ¯ä¸ªåŒºå—ä¹‹åå°† Trie å®Œæ•´å†™å…¥ç£ç›˜**ï¼Œè¿™ç§å®Œæ•´æŒä¹…åŒ–åªå‘ç”Ÿåœ¨ â€œå½’æ¡£æ¨¡å¼â€ï¼ˆ`--gcmode archive`ï¼‰ä¸‹ï¼Œè€Œå¤§å¤šæ•°ä¸»ç½‘èŠ‚ç‚¹å¹¶ä¸ä½¿ç”¨å½’æ¡£æ¨¡å¼ã€‚

é‚£æ™®é€šæ¨¡å¼ä¸‹ï¼ŒçŠ¶æ€æ˜¯æ€ä¹ˆå†™å…¥ç£ç›˜çš„å‘¢ï¼Ÿå®é™…ä¸Šï¼Œ**çŠ¶æ€æ›´æ–°ä¼šå…ˆç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå»¶è¿Ÿå†™å…¥ç£ç›˜**ã€‚è¿™ä¸ªæœºåˆ¶å«åšâ€œå»¶è¿Ÿåˆ·ç›˜â€ï¼ˆdelayed flushï¼‰ï¼Œè§¦å‘æ¡ä»¶åŒ…æ‹¬ï¼š

- â±ï¸ **å®šæ—¶åˆ·ç›˜**ï¼šé»˜è®¤æ¯éš” 5 åˆ†é’Ÿï¼ˆç­‰ä»·äºå¤„ç†å®Œçº¦ 5 åˆ†é’Ÿå†…çš„åŒºå—ï¼‰ä¼šè‡ªåŠ¨å†™å…¥ä¸€æ¬¡ã€‚
- ğŸ’¾ **ç¼“å­˜å®¹é‡è¾¾åˆ°ä¸Šé™**ï¼šå½“çŠ¶æ€ç¼“å­˜å¡«æ»¡ï¼Œå¿…é¡»åˆ·ç›˜é‡Šæ”¾å†…å­˜ã€‚
- â›” **èŠ‚ç‚¹å…³é—­æ—¶**ï¼šä¸ºäº†æ•°æ®å®Œæ•´æ€§ï¼Œæ‰€æœ‰ç¼“å­˜éƒ½ä¼šåˆ·ç›˜ã€‚

å°½ç®¡ `HashDB` çš„ç»“æ„è®¾è®¡å¾ˆç®€å•ï¼Œä½†å®ƒåœ¨å†…å­˜ç®¡ç†æ–¹é¢éå¸¸å¤æ‚ï¼Œç‰¹åˆ«æ˜¯ **å¯¹å¤±æ•ˆèŠ‚ç‚¹çš„åƒåœ¾å›æ”¶æœºåˆ¶**ï¼šå‡è®¾æŸä¸ªåˆçº¦åœ¨ä¸€ä¸ªåŒºå—è¢«åˆ›å»ºï¼Œåœ¨ä¸‹ä¸€ä¸ªåŒºå—å°±è¢«é”€æ¯ â€”â€” æ­¤æ—¶ä¸è¯¥åˆçº¦æœ‰å…³çš„çŠ¶æ€èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬åˆçº¦è´¦æˆ·å’Œå…¶ç‹¬ç«‹çš„å­˜å‚¨ Trieï¼‰éƒ½å·²ç»æ²¡ç”¨äº†ï¼Œå¦‚æœä¸æ¸…ç†ï¼Œå®ƒä»¬ä¼šç™½ç™½å ç”¨å†…å­˜ã€‚å› æ­¤ï¼Œ`HashDB` è®¾è®¡äº†å¼•ç”¨è®¡æ•°å’ŒèŠ‚ç‚¹ä½¿ç”¨è¿½è¸ªæœºåˆ¶æ¥åˆ¤æ–­å“ªäº›èŠ‚ç‚¹ä¸å†ä½¿ç”¨å¹¶ä»ç¼“å­˜ä¸­æ¸…é™¤ã€‚

### TrieDB ä¹‹ PathDB

`PathDB` æ˜¯ `TrieDB` çš„ä¸€ç§æ–°åç«¯å®ç°ã€‚å®ƒæ”¹å˜äº† Trie èŠ‚ç‚¹åœ¨ç£ç›˜ä¸ŠæŒä¹…åŒ–å’Œå†…å­˜ä¸­ç»´æŠ¤çš„æ–¹å¼ã€‚å¦‚å‰æ‰€è¿°ï¼Œ`HashDB` æ˜¯é€šè¿‡èŠ‚ç‚¹çš„å“ˆå¸Œè¿›è¡Œç´¢å¼•å­˜å‚¨çš„ã€‚è€Œè¿™ç§æ–¹æ³•è®©æ¸…é™¤ï¼ˆpruneï¼‰çŠ¶æ€ä¸­ä¸å†ä½¿ç”¨çš„éƒ¨åˆ†å˜å¾—éå¸¸å›°éš¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é•¿æœŸé—®é¢˜ï¼Œ[Geth å¼•å…¥äº† `PathDB`](https://github.com/ethereum/go-ethereum/issues/23427)ã€‚

`PathDB`ä¸ `HashDB` æœ‰å‡ ä¸ªæ˜¾è‘—åŒºåˆ«ï¼š

- Trie èŠ‚ç‚¹åœ¨æ•°æ®åº“ä¸­æ˜¯æŒ‰ç…§å…¶è·¯å¾„ï¼ˆpathï¼‰ä½œä¸ºé”®è¿›è¡Œå­˜å‚¨çš„ã€‚æŸè´¦æˆ·æˆ–storage keyèŠ‚ç‚¹çš„è·¯å¾„ä¸ºè¯¥è´¦æˆ·åœ°å€å“ˆå¸Œæˆ–storage keyåœ¨trieæ ‘ä¸Šä¸å…¶ä»–èŠ‚ç‚¹å…¬å…±å‰ç¼€éƒ¨åˆ†ï¼›æŸä¸ªåˆçº¦çš„ storage Trie ä¸­çš„èŠ‚ç‚¹ï¼Œå…¶è·¯å¾„å‰ç¼€åŒ…å«è¯¥è´¦æˆ·åœ°å€å“ˆå¸Œã€‚

```jsx
account trie node key = Prefix(1byte) || COMPACTED(node_path)
storage trie node key = Prefix(1byte) || account hash(32byte) || COMPACTed(node_pathï¼‰
```

- `HashDB` ä¼šå®šæœŸæŠŠæ¯ä¸ªåŒºå—çš„å®Œæ•´çŠ¶æ€åˆ·ç›˜ã€‚è¿™æ„å‘³ç€å³ä½¿æ˜¯ä½ å¹¶ä¸å…³å¿ƒçš„æ—§åŒºå—ï¼Œä¹Ÿä¼šæ®‹ç•™å®Œæ•´çŠ¶æ€ã€‚è€Œ `PathDB` å§‹ç»ˆåªåœ¨ç£ç›˜ä¸Šç»´æŠ¤ä¸€æ£µ Trieã€‚æ¯ä¸ªåŒºå—åªæ›´æ–°åŒä¸€æ£µ Trieã€‚å› ä¸ºä½¿ç”¨è·¯å¾„ä½œä¸ºé”®ï¼ŒèŠ‚ç‚¹çš„ä¿®æ”¹ä»…éœ€è¦†ç›–æ—§èŠ‚ç‚¹å³å¯ï¼›è¢«æ¸…é™¤çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥å®‰å…¨åˆ é™¤ï¼Œå› ä¸ºæ²¡æœ‰å…¶ä»– Trie ä¼šå¼•ç”¨å®ƒä»¬ã€‚
- è¢«æŒä¹…åŒ–çš„è¿™æ£µ Trie å¹¶éé“¾çš„æœ€æ–°å¤´éƒ¨ï¼Œè€Œæ˜¯è½åå¤´éƒ¨**è‡³å°‘ 128 ä¸ªåŒºå—**ã€‚æœ€è¿‘ 128 ä¸ªåŒºå—çš„ Trie æ›´æ”¹åˆ™åˆ†åˆ«å­˜åœ¨å†…å­˜ä¸­ï¼Œç”¨äºåº”å¯¹çŸ­é“¾é‡ç»„ï¼ˆreorgï¼‰ï¼›
- å¦‚æœå‡ºç°æ›´å¤§çš„ reorgï¼Œ`PathDB`ä¼šåˆ©ç”¨ freezer ä¸­é¢„å­˜çš„æ¯ä¸ªåŒºå—çš„ state diffï¼ˆçŠ¶æ€å·®å¼‚ï¼‰è¿›è¡Œé€†åº”ç”¨ï¼ˆrollbackï¼‰ï¼Œå°†ç£ç›˜çŠ¶æ€å›æ»šè‡³åˆ†å‰ç‚¹ã€‚

## 2.5 RawDB

åœ¨ Geth ä¸­ï¼Œ`rawdb` æ˜¯ä¸€ä¸ªåº•å±‚æ•°æ®åº“è¯»å†™æ¨¡å—ï¼Œå®ƒç›´æ¥å°è£…äº†å¯¹çŠ¶æ€ã€åŒºå—é“¾æ•°æ®ã€Trie èŠ‚ç‚¹ç­‰æ ¸å¿ƒæ•°æ®çš„å­˜å–é€»è¾‘ï¼Œæ˜¯**æ•´ä¸ªå­˜å‚¨ç³»ç»Ÿçš„åŸºç¡€æ¥å£å±‚**ã€‚å®ƒå¹¶ä¸ç›´æ¥æš´éœ²ç»™ EVM æˆ–ä¸šåŠ¡é€»è¾‘å±‚ï¼Œè€Œæ˜¯ä½œä¸ºå†…éƒ¨å·¥å…·æœåŠ¡äºå¦‚ `TrieDB`ã€`StateDB`ã€`BlockChain` ç­‰æ¨¡å—çš„æŒä¹…åŒ–æ“ä½œã€‚`rawdb` å’Œ `trie` ä¸€æ ·ï¼Œå¹¶ä¸ç›´æ¥å­˜å‚¨æ•°æ®æœ¬èº«ï¼Œå®ƒä»¬éƒ½æ˜¯**å¯¹åº•å±‚æ•°æ®åº“çš„æŠ½è±¡å°è£…å±‚**ï¼Œè´Ÿè´£å®šä¹‰å­˜å–è§„åˆ™ï¼Œè€Œéæ‰§è¡Œæœ€ç»ˆçš„æ•°æ®è½ç›˜æˆ–è¯»å–ã€‚å¯ä»¥æŠŠ `rawdb` çœ‹ä½œæ˜¯ Geth çš„â€œç¡¬ç›˜é©±åŠ¨å™¨â€ï¼Œå®ƒå®šä¹‰äº†**æ‰€æœ‰æ ¸å¿ƒé“¾ä¸Šæ•°æ®çš„é”®å€¼æ ¼å¼å’Œè®¿é—®æ¥å£**ï¼Œè´Ÿè´£ç¡®ä¿ä¸åŒæ¨¡å—å¯ä»¥ç»Ÿä¸€ã€å¯é åœ°è¯»å†™æ•°æ®ã€‚è™½ç„¶åœ¨ç›´æ¥å¼€å‘ä¸­å¾ˆå°‘ä¼šä½¿ç”¨å®ƒï¼Œä½†å®ƒæ˜¯æ•´ä¸ª Geth å­˜å‚¨å±‚æœ€åŸºç¡€ã€æœ€å…³é”®çš„ä¸€ç¯ã€‚

### æ ¸å¿ƒåŠŸèƒ½

æºç ä¸­ï¼Œ`rawdb` ä¸»è¦å®šä½äº`core/rawdb/accessors_trie.go`ã€‚`rawdb` æä¾›äº†å¤§é‡ `ReadXxx` å’Œ `WriteXxx` ç­‰è¯»å†™æ–¹æ³•ï¼Œç”¨äºæ ‡å‡†åŒ–åœ°è®¿é—®ä¸åŒç±»å‹çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼š

- åŒºå—æ•°æ®ï¼ˆ`core/rawdb/accessors_chain.go`ï¼‰ï¼š`ReadBlock`, `WriteBlock`, `ReadHeader`ç­‰
- çŠ¶æ€æ•°æ®ï¼ˆ`core/rawdb/accessors_trie.go`ï¼‰ï¼š`WriteLegacyTrieNode`, `ReadTrieNode`ç­‰
- æ€»ä½“å…ƒæ•°æ®ï¼šå¦‚æ€»éš¾åº¦ã€æœ€æ–°å¤´åŒºå—å“ˆå¸Œã€åˆ›ä¸–ä¿¡æ¯ç­‰

è¿™äº›æ–¹æ³•é€šå¸¸ä»¥çº¦å®šå¥½çš„ key å‰ç¼€ï¼ˆå¦‚ `h` è¡¨ç¤º header, `b` è¡¨ç¤º block, `a` è¡¨ç¤º AccountTrieNodeï¼‰ç»„ç»‡æ•°æ®åœ¨åº•å±‚æ•°æ®åº“ä¸­ï¼ˆLevelDB æˆ– PebbleDBï¼‰ã€‚

### ä¸ TrieDB çš„å…³ç³»

`TrieDB` æœ¬èº«å¹¶ä¸ç›´æ¥æ“ä½œç¡¬ç›˜ï¼Œå®ƒæŠŠå…·ä½“çš„è¯»å†™å§”æ‰˜ç»™ `rawdb`ã€‚è€Œ `rawdb` åˆä¼šè°ƒç”¨æ›´åº•å±‚çš„ `ethdb.KeyValueStore` æ¥å£ï¼Œè¿™å¯èƒ½æ˜¯ LevelDBã€PebbleDB æˆ–å†…å­˜æ•°æ®åº“ã€‚ä¾‹å¦‚ï¼Œå†™å…¥ `Trie`ç›¸å…³çš„æ•°æ®ï¼ˆè´¦æˆ·ã€å­˜å‚¨æ§½ç­‰ï¼‰æ—¶:

- åŸºäº`HashDB` çš„ Trie èŠ‚ç‚¹é‡‡ç”¨`rawdb.WriteLegacyTrieNode` ç­‰æ–¹æ³•è´Ÿè´£å°†ä»¥ `(hash, rlp-encoded node)` çš„å½¢å¼å†™å…¥æ•°æ®åº“ã€‚
- åŸºäº`PathDB`çš„ Trie èŠ‚ç‚¹åˆ™é‡‡ç”¨`WriteAccountTrieNode, WriteStorageTrieNode` ç­‰æ–¹æ³•å°†ä»¥`ï¼ˆpath, rlp-encoded node)`çš„å½¢å¼å†™å…¥æ•°æ®åº“ã€‚

## 2.6 EthDB

åœ¨ Geth ä¸­ï¼Œ`ethdb` æ˜¯æ•´ä¸ªå­˜å‚¨ç³»ç»Ÿçš„æ ¸å¿ƒæŠ½è±¡ï¼Œå®ƒæ‰®æ¼”ç€â€œç”Ÿå‘½ä¹‹æ ‘â€çš„è§’è‰²â€”â€”æ·±æ·±æ‰æ ¹äºç£ç›˜ï¼Œå‘ä¸Šä¼ é€’æ”¯æŒè‡³ `EVM` ä¸æ‰§è¡Œå±‚å„ä¸ªç»„ä»¶ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯**å±è”½åº•å±‚æ•°æ®åº“å®ç°çš„å·®å¼‚**ï¼Œä¸ºæ•´ä¸ª Geth æä¾›ç»Ÿä¸€çš„é”®å€¼è¯»å†™æ¥å£ã€‚æ­£å› å¦‚æ­¤ï¼ŒGeth åœ¨ä»»æ„åœ°æ–¹éƒ½ä¸ç›´æ¥ä½¿ç”¨å…·ä½“çš„æ•°æ®åº“ï¼ˆå¦‚ LevelDBã€PebbleDBã€MemoryDBç­‰ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ `ethdb` æä¾›çš„æ¥å£è¿›è¡Œæ•°æ®è®¿é—®ã€‚

### æ¥å£æŠ½è±¡ä¸èŒè´£åˆ’åˆ†

æºç ä¸­ï¼Œ`ethdb` ä¸»è¦å®šä½äº`ethdb/database.go`ã€‚`ethdb` ä¸­æœ€æ ¸å¿ƒçš„æ¥å£æ˜¯ `KeyValueStore()`,å®ƒå®šä¹‰äº†å¸¸è§çš„é”®å€¼æ“ä½œæ–¹æ³•ï¼š

```go
type KeyValueStore interface {
	Has(key []byte) (bool, error)
	Get(key []byte) ([]byte, error)
	Put(key []byte, value []byte) error
	Delete(key []byte) error
}

```

è¿™å¥—æ¥å£éå¸¸ç®€æ´ï¼Œè¦†ç›–äº†åŸºç¡€è¯»å†™æ“ä½œã€‚è€Œæ‰©å±•æ¥å£ `ethdb.Database` åˆ™åœ¨æ­¤åŸºç¡€ä¸ŠåŠ å…¥äº†å¯¹ **freezer å†·å­˜å‚¨çš„è¯»å†™æ”¯æŒï¼ˆ`AncientStore`ï¼‰**ï¼Œä¸»è¦ç”¨äºé“¾æ•°æ®ï¼ˆå¦‚å†å²åŒºå—ã€äº¤æ˜“å›æ‰§ï¼‰çš„ç®¡ç†ï¼šæ–°è¿‘åŒºå—ä¿å­˜åœ¨ KV å­˜å‚¨ä¸­ï¼Œè¾ƒè€çš„åˆ™è¿ç§»è‡³ freezerã€‚

æ­¤å¤–ï¼Œ`ethdb` è¿˜æä¾›äº†å¤šç§å…·ä½“å®ç°ç‰ˆæœ¬ï¼š

- `LevelDB`ï¼šæœ€æ—©æœŸçš„é»˜è®¤å®ç°ï¼Œç¨³å®šæˆç†Ÿã€‚
- `PebbleDB`ï¼šç›®å‰æ¨èä½¿ç”¨çš„é»˜è®¤å®ç°ï¼Œæ›´å¿«ã€èµ„æºæ•ˆç‡æ›´é«˜ã€‚
- `RemoteDB`ï¼šç”¨äºè¿œç¨‹çŠ¶æ€è®¿é—®åœºæ™¯ï¼Œåœ¨è½»èŠ‚ç‚¹ã€éªŒè¯è€…æˆ–æ¨¡å—åŒ–æ‰§è¡Œç¯å¢ƒä¸­å°¤ä¸ºé‡è¦ã€‚
- `MemoryDB`ï¼šå®Œå…¨å†…å­˜å®ç°ï¼Œå¸¸ç”¨äº dev æ¨¡å¼å’Œå•å…ƒæµ‹è¯•ã€‚

è¿™è®© Geth èƒ½å¤Ÿçµæ´»åœ°åœ¨ä¸åŒåœºæ™¯é—´åˆ‡æ¢å­˜å‚¨åç«¯ï¼Œæ¯”å¦‚å¼€å‘è°ƒè¯•ä½¿ç”¨ `MemoryDB`ï¼Œä¸»ç½‘ä¸Šçº¿ä½¿ç”¨ `PebbleDB`ã€‚

### ç”Ÿå‘½å‘¨æœŸä¸æ¨¡å—è´¯é€š

æ¯ä¸ª Geth èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºå”¯ä¸€çš„ `ethdb` å®ä¾‹ï¼Œè¿™ä¸ªå¯¹è±¡è´¯ç©¿ç¨‹åºå§‹ç»ˆï¼Œç›´åˆ°èŠ‚ç‚¹å…³é—­ã€‚åœ¨ç»“æ„è®¾è®¡ä¸Šï¼Œå®ƒè¢«æ³¨å…¥åˆ° `core.Blockchain` ä¸­ï¼Œè¿›è€Œä¼ é€’åˆ° `StateDB`ã€`TrieDB` ç­‰æ¨¡å—ï¼Œæˆä¸ºå…¨å±€å…±äº«çš„æ•°æ®è®¿é—®å…¥å£ã€‚

æ­£å› ä¸º `ethdb` æŠ½è±¡äº†åº•å±‚æ•°æ®åº“ç»†èŠ‚ï¼ŒGeth çš„å…¶ä»–ç»„ä»¶æ‰èƒ½ä¸“æ³¨äºå„è‡ªçš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ï¼š

- `StateDB` åªå…³å¿ƒè´¦æˆ·å’Œå­˜å‚¨æ§½ï¼›
- `TrieDB` åªå…³å¿ƒå¦‚ä½•å­˜å‚¨å’ŒæŸ¥æ‰¾ Trie èŠ‚ç‚¹ï¼›
- `rawdb` åªå…³å¿ƒå¦‚ä½•ç»„ç»‡é“¾æ•°æ®çš„é”®å€¼å¸ƒå±€ï¼›

è¿™äº›ä¸Šå±‚ç»„ä»¶éƒ½æ— éœ€æ„ŸçŸ¥æ•°æ®æ˜¯å­˜åœ¨å“ªä¸ªå…·ä½“æ•°æ®åº“å¼•æ“é‡Œã€‚

# 3. å…­ç§ DB çš„åˆ›å»ºé¡ºåºå’Œè°ƒç”¨é“¾

æœ¬èŠ‚ä» Geth èŠ‚ç‚¹å¯åŠ¨å¼€å§‹ï¼Œæ¢³ç†è¿™ 6 ç§ DB çš„å¯åŠ¨æµç¨‹å’Œè°ƒç”¨å…³ç³»ã€‚

## 3.1 åˆ›å»ºé¡ºåºï¼š

æ•´ä½“åˆ›å»ºé¡ºåºä¸º`ethdb â†’ rawdb/TrieDB â†’ state.Database â†’ stateDB â†’ trie`ï¼Œæºç ä¸­å…·ä½“è°ƒç”¨é“¾å¦‚ä¸‹:

```bash
ã€èŠ‚ç‚¹åˆå§‹åŒ–é˜¶æ®µã€‘
MakeChain
â””â”€â”€ MakeChainDatabase
â””â”€â”€ node.OpenDatabaseWithFreezer
â””â”€â”€ node.openDatabase
â””â”€â”€ node.openKeyValueDatabase
â””â”€â”€ newPebbleDBDatabase / remotedb
â†“
ethdb.Database
â†“
rawdb.Database (å°è£… ethdb)
â””â”€â”€ rawdb.NewDatabaseWithFreezer(ethdb)
â†“
trie.Database (TrieDB)
â””â”€â”€ trie.NewDatabase(ethdb)
â””â”€â”€ backend: pathdb.New(ethdb) / hashdb.New(ethdb)
â†“
state.Database (cachingDB)
â””â”€â”€ state.NewDatabase(trieDB)
â†“
ã€åŒºå—å¤„ç†é˜¶æ®µã€‘
chain.InsertChain
â””â”€â”€ bc.insertChain
â””â”€â”€ state.New(root, state.Database)
â†“
state.StateDB
â””â”€â”€ stateDB.OpenTrie()
â””â”€â”€ stateDB.OpenStorageTrie()
â†“
trie.Trie / SecureTrie
```

## 3.2 ç”Ÿå‘½å‘¨æœŸä¸€è§ˆ

| DBæ¨¡å— | åˆ›å»ºæ—¶æœº | ç”Ÿå‘½å‘¨æœŸ | ä¸»è¦èŒè´£ |
| --- | --- | --- | --- |
| **ethdb.Database** | èŠ‚ç‚¹åˆå§‹åŒ– | ç¨‹åºå…¨ç¨‹ | æŠ½è±¡åº•å±‚å­˜å‚¨ï¼Œç»Ÿä¸€æ¥å£ï¼ˆLevelDB / PebbleDB / Memoryï¼‰ |
| **rawdb** | åŒ…è£¹ ethdb è°ƒç”¨ | ä¸å­˜å‚¨æ•°æ®æœ¬èº« | æä¾›åŒºå—/receipt/æ€»éš¾åº¦ç­‰é“¾æ•°æ®çš„è¯»å†™æ¥å£ |
| **TrieDB** | `core.NewBlockChain()` | ç¨‹åºå…¨ç¨‹ | ç¼“å­˜+æŒä¹…åŒ– PathDB/HashDB èŠ‚ç‚¹ |
| **state.Database** | `core.NewBlockChain()` | ç¨‹åºå…¨ç¨‹ | å°è£… TrieDBï¼Œåˆçº¦ä»£ç ç¼“å­˜ï¼ŒåæœŸæ”¯æŒ Verkle è¿ç§» |
| **state.StateDB** | æ¯ä¸ªåŒºå—æ‰§è¡Œå‰åˆ›å»ºä¸€æ¬¡ | åŒºå—æ‰§è¡ŒæœŸé—´ | ç®¡ç†çŠ¶æ€è¯»å†™ï¼Œè®¡ç®—çŠ¶æ€æ ¹ï¼Œè®°å½•çŠ¶æ€å˜æ›´ |
| **trie.Trie** | æ¯æ¬¡è´¦æˆ·æˆ–slotè®¿é—®æ—¶åˆ›å»º | ä¸´æ—¶ï¼Œä¸å­˜å‚¨æ•°æ®æœ¬èº« | è´Ÿè´£ Trie ç»“æ„ä¿®æ”¹å’Œæ ¹å“ˆå¸Œè®¡ç®— |

# 4. HashDB å’Œ PathDB çŠ¶æ€æäº¤å’Œè¯»å–æœºåˆ¶è¯¦ç»†å¯¹æ¯”

åŒºå—æ‰§è¡Œå®Œæ¯•åStateDBä¼šè°ƒç”¨`func (s ***StateDB**) **Commit**(block uint64, deleteEmptyObjects bool, noStorageWiping bool)`ï¼Œå¹¶è§¦å‘å¦‚ä¸‹å­˜å‚¨çŠ¶æ€æ›´æ–°:

- é€šè¿‡`ret, err := s.**commit**(deleteEmptyObjects, noStorageWiping)`æ”¶é›† Trie çŠ¶æ€æ ‘æ¶‰åŠåˆ°çš„æ‰€æœ‰æ›´æ–°
    
    ```
    func (s *StateDB) commit(deleteEmptyObjects bool, noStorageWiping bool) (*stateUpdate, error) {
        ...
    		newroot, set := s.trie.Commit(true)
    		root = newroot
    		...
    		}
    ```
    
    - å…¶ä¸­è°ƒç”¨åˆ°çš„`trie.Commit`æ–¹æ³•ä¼šæŠŠæ‰€æœ‰çš„èŠ‚ç‚¹ï¼ˆä¸è®ºæ˜¯shortèŠ‚ç‚¹è¿˜æ˜¯fullèŠ‚ç‚¹ï¼‰[å¡Œç¼©ä¸ºhashèŠ‚ç‚¹](https://github.com/ethereum/go-ethereum/blob/4dfec7e83e4634cc8ab254b4bdbe9e692142316b/trie/committer.go#L51)`t.root = **newCommitter**(nodes, t.tracer, collectLeaf).**Commit**(t.root, t.uncommitted > 100)`ï¼Œå¹¶æ”¶é›†æ‰€æœ‰è„èŠ‚ç‚¹è¿”å›ç»™ StateDB
    - StateDBåˆ©ç”¨æ”¶é›†åˆ°çš„æ‰€æœ‰è„èŠ‚ç‚¹æ›´æ–°TrieDBç¼“å­˜å±‚ï¼š
        - `HashDB`åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†`dirties map[**common**.**Hash**]***cachedNode**`è¿™ä¸ªå¯¹è±¡æ¥ç¼“å­˜è¿™äº›æ›´æ–°ï¼Œå¹¶æ›´æ–°ç›¸åº”çš„trieèŠ‚ç‚¹å¼•ç”¨ï¼Œç¼“å­˜æœ‰å¤§å°é™åˆ¶
        - `PathDB`åˆ™åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†`tree ***layerTree**` Â è¿™ä¸ªå¯¹è±¡å¹¶å¢åŠ ä¸€å±‚diffæ¥ç¼“å­˜è¿™äº›æ›´æ–°ï¼Œæœ€å¤šå¯ç¼“å­˜128å±‚diff
    
    ```go
    func (s *StateDB) commitAndFlush(block uint64, deleteEmptyObjects bool, noStorageWiping bool) (*stateUpdate, error) {
    		...
    		// If trie database is enabled, commit the state update as a new layer
    		if db := s.db.TrieDB(); db != nil {
    			start := time.Now()
    			if err := db.Update(ret.root, ret.originRoot, block, ret.nodes, ret.stateSet()); err != nil {
    				return nil, err
    			}
    			s.TrieDBCommits += time.Since(start)
    		}
    		...
    ```
    
- å½“`HashDB`æˆ–`PathDB`ç¼“å­˜è¶…é™æ—¶ï¼Œåˆ™ä¼šè§¦å‘flushï¼Œé€šè¿‡`rawdb`æä¾›çš„ç›¸å…³æ¥å£å°†ç¼“å­˜å†™å…¥`ethdb`çš„å®é™…æŒä¹…å±‚ï¼š
    - å…¨èŠ‚ç‚¹`HashDB`æ¨¡å¼ä¸‹ï¼Œç”±äºkeyæ˜¯hashï¼Œæ‰€ä»¥åŒä¸€ä¸ªè´¦æˆ·å¦‚æœè¢«ä¿®æ”¹ï¼Œ**ç”±äºåº•å±‚æ•°æ®åº“é€šè¿‡keyæ— æ³•æ„ŸçŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªè´¦æˆ·ï¼Œä¸èƒ½è½»æ˜“åˆ é™¤è¯¥keyåŠå…¶å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å¯èƒ½ä¼šå½±å“å…¶ä»–è´¦æˆ·çŠ¶æ€**ï¼Œæ‰€ä»¥åªä¼šæŠŠæ–°ä¿®æ”¹çš„KVå†™å…¥DBï¼Œè€Œæ— æ³•åˆ é™¤æ—§çŠ¶æ€ï¼Œå› æ­¤å…¨èŠ‚ç‚¹çŠ¶æ€å¾ˆéš¾è¢«ä¿®å‰ªã€‚ä¾‹å¦‚ä¸¤ä¸ªä¸åŒçš„åˆçº¦åœ°å€Aå’ŒBå®é™…ä¿å­˜ç›¸åŒçš„åˆçº¦ä»£ç ï¼Œä»–ä»¬åœ¨`HashDB`ä¸­å…±äº«åŒä¸€ä¸ªï¼ˆkeyä¸ºhashï¼Œvalueä¸ºåˆçº¦ä»£ç ï¼‰çš„å­˜å‚¨ï¼Œè‹¥EVMæ‰§è¡Œåé”€æ¯å…¶ä¸­ä¸€ä¸ªåˆçº¦Aï¼Œå¦å¤–ä¸€ä¸ªåˆçº¦Bä»£ç å’Œåˆçº¦Aä»£ç åœ¨æ•°æ®åº“ä¸­çš„keyä¸€æ ·ï¼Œæ‰€ä»¥ä¸èƒ½éšæ„åˆ é™¤æ•°æ®åº“ä¸­hashä¸ºkeyçš„å€¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´Båˆçº¦åé¢è¯»å–ä¸åˆ°è¯¥åˆçº¦ä»£ç äº†ã€‚
    - å…¨èŠ‚ç‚¹`PathDB`æ¨¡å¼ä¸‹ï¼Œç”±äºkeyæ˜¯pathï¼Œæ‰€ä»¥åŒä¸€ä¸ªè´¦æˆ·åœ¨åº•å±‚DBå¯¹åº”çš„keyæ˜¯ä¸€æ ·çš„ï¼Œä¼šæŠŠåŒä¸€ä¸ªè´¦æˆ·å¯¹åº”çš„çŠ¶æ€è¦†ç›–æ‰ï¼Œå› æ­¤æ›´å®¹æ˜“è£å‰ªå…¨èŠ‚ç‚¹çš„çŠ¶æ€ã€‚å› æ­¤ç°åœ¨Gethå…¨èŠ‚ç‚¹é»˜è®¤é‡‡ç”¨çš„æ˜¯`PathDB`æ¨¡å¼
    - ç”±äº å½’æ¡£ï¼ˆarchiveï¼‰èŠ‚ç‚¹éœ€è¦å­˜å‚¨æ¯ä¸€ä¸ªåŒºå—å¯¹åº”çš„çŠ¶æ€ï¼Œæ­¤æ—¶`HashDB`åˆ™æ›´å…·ä¼˜åŠ¿ï¼Œå› ä¸ºä¸åŒåŒºå—ä¸‹å¾ˆå¤šè´¦æˆ·çš„æ•°æ®å®é™…ä¸Šå¹¶æœªä¿®æ”¹ï¼ŒåŸºäºhashä½œä¸ºkeyç›¸å½“äºè‡ªåŠ¨å…·å¤‡è£å‰ªçš„ç‰¹æ€§ï¼›è€Œæ­¤æ—¶`PathDB`åˆ™éœ€è¦ä¿å­˜æ¯ä¸ªåŒºå—ä¸‹æ‰€æœ‰è´¦æˆ·çš„çŠ¶æ€ï¼Œå¯¼è‡´çŠ¶æ€ä¼šè¶…çº§å¤§ï¼Œå› æ­¤Gethçš„archiveèŠ‚ç‚¹åªæ”¯æŒ`HashDB`æ¨¡å¼

## å®ä¾‹ï¼šå…¨èŠ‚ç‚¹ä¸‹ HashDB å’Œ PathDB å®é™…è½ç›˜å¯¹æ¯”

å‡è®¾å·¦è¾¹çš„ Trie æ˜¯ MPT çš„åˆå§‹çŠ¶æ€ï¼Œå…¶ä¸­çº¢è‰²çš„æ˜¯å°†è¢«ä¿®æ”¹çš„èŠ‚ç‚¹ï¼›å³è¾¹çš„åˆ™æ˜¯ MPT çš„æ–°çŠ¶æ€ï¼Œç»¿è‰²è¡¨ç¤ºä¹‹å‰çš„4ä¸ªçº¢è‰²èŠ‚ç‚¹è¢«ä¿®æ”¹äº†ã€‚

![å­˜å‚¨æ¶æ„å›¾2](Gethæºç ç³»åˆ—ï¼šå­˜å‚¨è®¾è®¡åŠå®ç°/image1.png)

- åœ¨`HashDB`æ¨¡å¼ä¸‹ï¼Œç”±äº C/D/EèŠ‚ç‚¹æ›´æ”¹åhashå¿…å®šä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤å°½ç®¡ C/D/E èŠ‚ç‚¹å¯¹åº”çš„ä¸‰ä¸ªè´¦æˆ·ä¹‹å‰å·²ç»è½ç›˜äº†ï¼Œè¿™ä¸‰ä¸ªè´¦æˆ·å¯¹åº”çš„æ–°èŠ‚ç‚¹ Câ€™/Dâ€™/Eâ€™ è¿˜æ˜¯éœ€è¦è½ç›˜ï¼Œä¸”ä¸€æ—¦æŒä¹…åŒ–ä¹‹åå°±å¾ˆéš¾åˆ é™¤è¿™äº›æ—§èŠ‚ç‚¹äº†ã€‚ç£ç›˜æ›´æ–°ä¹‹å‰ï¼ˆå·¦å›¾ï¼‰å’Œä¹‹åï¼ˆå³å›¾ï¼‰çš„çŠ¶æ€å¦‚ä¸‹ï¼Œå…¶ä¸­collapsed Nodeå¯ä»¥ç®€å•ç†è§£ä¸ºèŠ‚ç‚¹å­˜å‚¨çš„å€¼ã€‚

![å­˜å‚¨æ¶æ„å›¾3](Gethæºç ç³»åˆ—ï¼šå­˜å‚¨è®¾è®¡åŠå®ç°/image2.png)

- åœ¨`PathDB`æ¨¡å¼ä¸‹ï¼Œè™½ç„¶ C/D/E èŠ‚ç‚¹å¯¹åº”çš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯ç”±äºåº•å±‚å­˜å‚¨çš„ key(path) ä¸å˜ï¼Œåœ¨æŒä¹…åŒ–æ˜¯å¯ä»¥ç›´æ¥æ›¿æ¢è¿™ä¸‰ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å€¼ä¸º Câ€™/Dâ€™/Eâ€™ å°±å¯ä»¥äº†ï¼Œç£ç›˜æ•°æ®å¹¶ä¸ä¼šæœ‰è¿‡å¤šå†—ä½™ï¼ˆè™½ç„¶æœ‰äº›ç›¸åŒçš„åˆçº¦å¯èƒ½ä¼šåœ¨ä¸åŒçš„ pathä¸‹éƒ½ä¿å­˜äº†ä¸€ä»½ï¼Œä½†æ˜¯å½±å“ä¸å¤§ï¼‰ã€‚ç£ç›˜æ›´æ–°ä¹‹å‰ï¼ˆå·¦å›¾ï¼‰å’Œä¹‹åï¼ˆå³å›¾ï¼‰çš„çŠ¶æ€å¦‚ä¸‹ã€‚

![å­˜å‚¨æ¶æ„å›¾4](Gethæºç ç³»åˆ—ï¼šå­˜å‚¨è®¾è®¡åŠå®ç°/1746510331955.png)

## å®ä¾‹: HashDB å’Œ PathDB è¯»å–è´¦æˆ·å¯¹æ¯”

åœ¨`core/rawdb/accessors_trie.go`ä¸­å¢åŠ å¦‚ä¸‹ debug ä»£ç ï¼Œæµ‹è¯• stateDB è¯»å–`0xB3329fcd12C175A236a02eC352044CE44d` ï¼ˆaccount hash:`0x**aea7c67d**a6a9bdb230dd07d0e96626e5e57c9cba04dc8039c923baefe55eacd1`ï¼‰æ¶‰åŠåˆ°çš„TrieèŠ‚ç‚¹æ•°æ®åº“è¯»å–:

```go
func ReadAccountTrieNode(db ethdb.KeyValueReader, path []byte) []byte {
	fmt.Println("PathDB read:", hexutil.Encode(accountTrieNodeKey(path)))
	data, _ := db.Get(accountTrieNodeKey(path))
	return data
}

func ReadLegacyTrieNode(db ethdb.KeyValueReader, hash common.Hash) []byte {
	fmt.Println("HashDB read:", hash)
	data, err := db.Get(hash.Bytes())
	if err != nil {
		return nil
	}
	return data
}
```

PathDB è¯»å–åˆ°çš„ Trie èŠ‚ç‚¹å¦‚ä¸‹ï¼Œå¯çœ‹å‡ºè¯»å–çš„æ˜¯è´¦æˆ·åœ°å€ hash çš„å‰ 8 ä½ç›¸åº” path çš„èŠ‚ç‚¹:

```bash
#0x41ä¸ºå‰ç¼€ï¼Œå¤šåŠ çš„0æ˜¯nibblesï¼ˆåŠå­—èŠ‚ï¼‰ çš„å¯¹é½éœ€è¦
PathDB read: 0x410a
PathDB read: 0x410a0e
PathDB read: 0x410a0e0a
PathDB read: 0x410a0e0a07
PathDB read: 0x410a0e0a070c
PathDB read: 0x410a0e0a070c06
PathDB read: 0x410a0e0a070c0607
PathDB read: 0x410a0e0a070c06070d
```

HashDB è¯»åˆ°çš„ Trie èŠ‚ç‚¹å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºè¯»å–æ˜¯çš„ hash ä¸º key å¯¹åº”çš„èŠ‚ç‚¹:

```go
HashDB read: 0xb01e32b0c38555bb27f1a924b8408824f97dd8d70f096b218d397906a9095385
HashDB read: 0x99d38ce254e6c35a49504345a30e94b4ea08338279385bae33feaaa11c3a0a00
HashDB read: 0xfcc42d902aa9107b83ee7839a8bc61b370cc5eac9ee60db1af7165daf6c3f76b
HashDB read: 0x3232bc99a88337d2aea2e8c237eb5b4ebb9366ff5bdd94b965ac6f918bd6303f
HashDB read: 0x04ae6f0462f6c0c7e5827dc46fcd69329483d829c39f624744f7b55c09c2cc96
HashDB read: 0x22a16c466cc420e8ed97fd484cecc8f73160ee74a56cfc87ff941d1b56ff46f8
HashDB read: 0xae26238e219065458f314e456265cd9c935e829ba82aebe6d38bacdbb14582f3
HashDB read: 0xe9ce7770c224e563b0c407618b7b7d8614da3d5da89f3960a3bec97e78fc0ae0
HashDB read: 0x2c7d134997a5c3e0bf47ff347479ee9318826f1c58689b3d9caeac77287c3af8
```

æ€»ä½“æ¥è¯´ï¼Œ`PathDB`å’Œ`HashDB`å‡æ˜¯ä¿æŒTrieæ•°æ®ç»“æ„æ¥å­˜å‚¨çŠ¶æ€æ•°æ®ï¼Œåªæ˜¯`PathDB`ä»¥TrieèŠ‚ç‚¹çš„`path`ä½œä¸ºkeyï¼Œè€Œ`HashDB`åˆ™æ˜¯ä»¥TrieèŠ‚ç‚¹å€¼å¯¹åº”çš„hashä½œä¸ºkeyï¼Œä¸¤è€…å‡å­˜å‚¨å€¼ç›¸åŒå‡ä¸ºTrieèŠ‚ç‚¹çš„å€¼ã€‚

# 5. DB ç›¸å…³è¯»å†™æ“ä½œæµç¨‹è¿½è¸ª

1. **äº¤æ˜“æ‰§è¡Œé˜¶æ®µ**
- æ‰€æœ‰è´¦æˆ·å’ŒStorageå€¼é€šè¿‡`StateDB.GetState`ç­‰æ–¹æ³•ç»è¿‡`Trieâ†’TrieDB(pathdb/hashdb)â†’RawDBâ†’Level/PebbleDB`è¯»å–åˆ°StateDBå†…å­˜ä¸­
- éšåEVMæ‰§è¡ŒçŠ¶æ€å˜æ›´ï¼ˆå¦‚è°ƒç”¨ `Statedb.SetBalance()` ï¼‰ä¹Ÿä¿ç•™åœ¨ StateDB çš„å†…å­˜ä¸­
    - åŒ…æ‹¬ï¼šä½™é¢å˜æ›´ã€nonce æ›´æ–°ã€storage ä¿®æ”¹
1. **å•ä¸ªåŒºå—æ‰§è¡Œå®Œæ¯•æ›´æ–°ç¼“å­˜**
- è°ƒç”¨ `StateDB.Commit()` â†’ æ”¶é›†è„èŠ‚ç‚¹è½¬åŒ–ä¸ºä¿®æ”¹çš„ Trie èŠ‚ç‚¹ç»„ï¼Œå¹¶è®¡ç®—æ–° StateRoot
- å†…éƒ¨è°ƒç”¨ `Trie.Commit()` â†’ è°ƒç”¨ `TrieDB.Update()`å°†æ›´æ”¹ä¿å­˜åœ¨ TrieDB ç¼“å­˜å±‚
    - PathDB æœ€å¤šæœ‰ 128 ä¸ªå—çš„ diff ç¼“å­˜å±‚é™åˆ¶
    - HashDB çš„ç¼“å­˜å±‚æœ‰å¤§å°é™åˆ¶
    - è¶…è¿‡ä¸Šè¿°é™åˆ¶åˆ™è¿›ä¸€æ­¥è§¦å‘`TrieDB.Commit`å®é™…è½ç›˜åˆ°åº•å±‚æ•°æ®åº“
1. **å•ä¸ªåŒºå—æ‰§è¡Œå®Œæ¯• Header / Receipts æäº¤ï¼š**
    - é™¤çŠ¶æ€ä»¥å¤–ï¼ŒåŒºå—å¤´ã€bodyã€äº¤æ˜“å›æ‰§ç­‰æ•°æ®é€šè¿‡ `RawDB.Write*(ethdb)` ç­‰æ¥å£å†™å…¥ `ethdb`å±‚
2. **å¤šä¸ªåŒºå—æ‰§è¡Œåç¼“å­˜è¶…é™è§¦å‘å®é™…è½ç›˜TrieDB.Commit â†’ batch â†’ DB**
    - èŠ‚ç‚¹æ˜¯å½’æ¡£èŠ‚ç‚¹node æˆ–è¶…è¿‡ flushInterval æˆ–è¶…è¿‡ TrieDB çš„ç¼“å­˜é™åˆ¶æˆ–èŠ‚ç‚¹å…³é—­å‰ï¼Œå¼€å§‹è§¦å‘commitï¼Œå¹¶æœ€ç»ˆè½ç›˜ã€‚å¦‚ä¸‹æ˜¯`PathDB`æ¨¡å¼ä¸‹è½ç›˜æ ¸å¿ƒä»£ç :

```go
func (db *Database) commit(hash common.Hash, batch ethdb.Batch, uncacher *cleaner) error {
	...
	rawdb.WriteLegacyTrieNode(batch, hash, node.node) // å¤šä¸ªä¿®æ”¹çš„trieèŠ‚ç‚¹åŠ å…¥ batchï¼ˆæœªè½ç›˜ï¼‰
	if batch.ValueSize() >= ethdb.IdealBatchSize { // è¾¾åˆ° IdealBatchSize åè§¦å‘å†™ç›˜
	    batch.Write()            // è½ç›˜
	    batch.Replay(uncacher)   // é€šçŸ¥ uncacher æ¸…ç†å†…å­˜
	    batch.Reset()            // é‡ç½® batch
	}
	...
```

# 6. æ€»ç»“

Geth ä¸­çš„è¿™ 6 ä¸ªæ•°æ®åº“æ¨¡å—å„è‡ªæ‰¿æ‹…ä¸åŒå±‚çº§çš„èŒè´£ï¼Œå½¢æˆäº†ä¸€æ¡è‡ªåº•å‘ä¸Šçš„æ•°æ®è®¿é—®é“¾ã€‚é€šè¿‡å¤šå±‚æŠ½è±¡ä¸å¤šçº§ç¼“å­˜ï¼Œä¸Šå±‚æ¨¡å—æ— éœ€å…³å¿ƒåº•å±‚çš„å…·ä½“å®ç°ï¼Œä»è€Œå®ç°äº†åº•å±‚å­˜å‚¨å¼•æ“çš„å¯æ’æ‹”æ€§ä¸è¾ƒé«˜çš„ I/O æ€§èƒ½ã€‚

æœ€åº•å±‚çš„ `ethdb` æŠ½è±¡äº†ç‰©ç†å­˜å‚¨ï¼Œå±è”½å…·ä½“æ•°æ®åº“ç±»å‹ï¼Œæ”¯æŒå¦‚ LevelDBã€Pebbleã€RemoteDB ç­‰å¤šç§åç«¯ï¼›å…¶ä¸Šä¸€å±‚æ˜¯ `rawdb`ï¼Œè´Ÿè´£å¯¹åŒºå—ã€åŒºå—å¤´ã€äº¤æ˜“ç­‰æ ¸å¿ƒé“¾ä¸Šæ•°æ®ç»“æ„çš„ç¼–ç ã€è§£ç ä¸å°è£…ï¼Œç®€åŒ–äº†é“¾æ•°æ®çš„è¯»å†™æ“ä½œã€‚`TrieDB` ç®¡ç†çŠ¶æ€æ ‘èŠ‚ç‚¹çš„ç¼“å­˜ä¸æŒä¹…åŒ–ï¼Œæ”¯æŒ `hashdb` ä¸ `pathdb` ä¸¤ç§åç«¯ï¼Œç”¨äºå®ç°ä¸åŒçš„çŠ¶æ€ä¿®å‰ªç­–ç•¥å’Œå­˜å‚¨æ–¹å¼ã€‚

å†å¾€ä¸Šï¼Œ`trie.Trie` æ˜¯çŠ¶æ€å˜åŒ–çš„æ‰§è¡Œå®¹å™¨ä¸æ ¹å“ˆå¸Œçš„è®¡ç®—æ ¸å¿ƒï¼Œæ‰¿æ‹…å®é™…çš„çŠ¶æ€æ„å»ºä¸éå†æ“ä½œï¼›`state.Database` å°è£…å¯¹è´¦æˆ·å’Œåˆçº¦å­˜å‚¨ Trie çš„ç»Ÿä¸€è®¿é—®ï¼Œå¹¶æä¾›åˆçº¦ä»£ç ç¼“å­˜ï¼›è€Œæœ€é¡¶å±‚çš„ `state.StateDB` æ˜¯åœ¨åŒºå—æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ EVM å¯¹æ¥çš„æ¥å£ï¼Œæä¾›è´¦æˆ·ä¸å­˜å‚¨çš„è¯»ç¼“å­˜å’Œå†™æ”¯æŒï¼Œä½¿å¾— EVM æ— éœ€æ„ŸçŸ¥åº•å±‚ Trie çš„å¤æ‚ç»“æ„ã€‚

è¿™äº›æ¨¡å—é€šè¿‡èŒè´£åˆ†ç¦»ä¸æ¥å£éš”ç¦»ï¼ŒååŒæ„å»ºäº†ä¸€ä¸ªæ—¢çµæ´»åˆé«˜æ•ˆçš„çŠ¶æ€ç®¡ç†ä½“ç³»ï¼Œä½¿ Geth èƒ½åœ¨å¤æ‚é“¾çŠ¶æ€ä¸äº¤æ˜“æ‰§è¡Œä¸­ä¿æŒè‰¯å¥½æ€§èƒ½ä¸å¯ç»´æŠ¤æ€§ã€‚

# References

[1][go-ethereum æºç ](https://github.com/ethereum/go-ethereum)

[2][The Tale of 5 DBs](https://s1na.substack.com/p/the-tale-of-5-dbs-24-07-26)

[3][Path-based storage & Inline prune - NodeReal](https://nodereal.io/blog/en/geth-path-based-storage-model-and-newly-inline-state-prune/)

[4][RLP ç¼–ç è§„èŒƒ](https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/)

[5][Ethereum data structures and encoding](https://ethereum.org/en/developers/docs/data-structures-and-encoding/)
